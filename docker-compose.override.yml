# Docker Compose override file for development
# This file is automatically loaded by docker-compose and extends docker-compose.yml
# Perfect for local development with hot-reload capabilities

version: '3.8'

services:
  ragbot-web:
    # Mount source code for live development
    volumes:
      # Override: mount source as read-write for development
      - ./src:/app/src:rw
      - ./engines.yaml:/app/engines.yaml:rw

      # Allow writing to curated-datasets and custom-instructions
      - ./curated-datasets:/app/curated-datasets:rw
      - ./custom-instructions:/app/custom-instructions:rw

    # Enable Streamlit's file watcher for hot-reload
    command: >
      streamlit run src/ragbot_streamlit.py
      --server.address 0.0.0.0
      --server.runOnSave true
      --server.fileWatcherType auto

    # Development environment variables
    environment:
      - STREAMLIT_SERVER_RUN_ON_SAVE=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

  # Development testing service
  ragbot-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ragbot-test
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    volumes:
      - ./src:/app/src:rw
      - ./tests:/app/tests:rw
      - ./engines.yaml:/app/engines.yaml:ro
    entrypoint: ["pytest"]
    command: ["-v", "tests/"]
    profiles: ["test"]
    networks:
      - ragbot-network
